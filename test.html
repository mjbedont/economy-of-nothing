<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Economy of Nothing | VR-1 Live Tuner</title>
    
    <link rel="stylesheet" href="style.css">
</head>
<body>

    <main>
        <div class="radio-header">
            <h1 style="margin:0; font-size: 1.1rem;">
                ECONOMY OF NOTHING <span style="color:var(--primary-color)">VR-1</span>
            </h1>
            <div class="tuner-controls" id="tuner"></div>
        </div>

        <div class="video-player">
            <div id="player"></div>
        </div>

        <div id="status" class="status-msg">INITIALIZING SIGNAL...</div>

        <div class="playlist-carousel" id="carousel">CONNECTING...</div>
    </main>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
        const CHANNELS = [
            { name: "MAIN FEED", id: "PLPrT6qMbooEmOi60hDqeFKFDgmO1lRfWA" },
            { name: "SEASON 1",  id: "PLPrT6qMbooEkg5emEYwACBuhh74adPnM8" },
            { name: "EXTRAS",    id: "PLPrT6qMbooEkl1D5Vhjo0AfJkchM0yHtV" }
        ];

        window.videos = [];
        window.currentIndex = 0;
        window.player = null;
        window.currentChannelId = CHANNELS[0].id;
        window.isPlaylistLoaded = false;

        // Create buttons that use your .channel-btn CSS class
        function buildTuner() {
            const tunerDiv = document.getElementById('tuner');
            CHANNELS.forEach(ch => {
                const btn = document.createElement('button');
                btn.className = 'channel-btn';
                btn.innerText = ch.name;
                btn.id = `btn-${ch.id}`;
                btn.onclick = () => switchChannel(ch.id);
                tunerDiv.appendChild(btn);
            });
            const activeBtn = document.getElementById(`btn-${window.currentChannelId}`);
            if(activeBtn) activeBtn.classList.add('active');
        }

        async function switchChannel(playlistId) {
            if (window.currentChannelId === playlistId && window.videos.length > 0) return;
            window.currentChannelId = playlistId;
            window.isPlaylistLoaded = false;

            document.querySelectorAll('.channel-btn').forEach(b => b.classList.remove('active'));
            const activeBtn = document.getElementById(`btn-${playlistId}`);
            if(activeBtn) activeBtn.classList.add('active');

            document.getElementById('status').innerText = "TUNING... SEARCHING FREQUENCY";
            document.getElementById('carousel').innerHTML = ""; 

            await loadPlaylist(playlistId);
            
            if (window.player && window.videos.length > 0) {
                window.tuneTo(0); 
            }
        }

        window.checkAndStart = function() {
            if (window.YT && window.YT.Player && window.isPlaylistLoaded && !window.player) {
                window.player = new YT.Player("player", {
                    width: "100%", height: "100%",
                    playerVars: { autoplay: 1, mute: 1, rel: 0, modestbranding: 1, playsinline: 1 },
                    events: {
                        onReady: () => {
                            document.getElementById('status').innerText = "FREQUENCY LOCKED | AUDIO MUTED";
                            window.tuneTo(0);
                        },
                        onStateChange: (e) => { if (e.data === YT.PlayerState.ENDED) nextVideo(); }
                    }
                });
            }
        };

        window.tuneTo = function(index) {
            if (!window.videos[index] || !window.player) return;
            window.currentIndex = index;
            
            const thumbnails = document.querySelectorAll('.playlist-carousel img');
            thumbnails.forEach((img, i) => {
                img.classList.toggle("active", i === index);
            });

            window.player.loadVideoById(window.videos[index].videoId);
        };

        window.nextVideo = function() {
            window.tuneTo((window.currentIndex + 1) % window.videos.length);
        };

        window.onYouTubeIframeAPIReady = function() { window.checkAndStart(); };

        async function loadPlaylist(playlistId) {
            try {
                window.videos = [];
                const cacheBuster = Date.now();
                const feedURL = `https://api.rss2json.com/v1/api.json?rss_url=https://www.youtube.com/feeds/videos.xml?playlist_id=${playlistId}&t=${cacheBuster}`;
                
                const res = await fetch(feedURL);
                const data = await res.json();
                const carousel = document.getElementById("carousel");
                carousel.innerHTML = "";
                
                data.items.forEach((item, index) => {
                    const videoId = item.link.split('v=')[1] || item.link.split('/').pop();
                    window.videos.push({ videoId });

                    const img = document.createElement("img");
                    img.src = item.thumbnail;
                    img.onclick = () => window.tuneTo(index);
                    carousel.appendChild(img);
                });

                const moreCard = document.createElement("a");
                moreCard.className = "more-card";
                moreCard.href = `https://www.youtube.com/playlist?list=${playlistId}`;
                moreCard.target = "_blank";
                moreCard.innerHTML = `<span>ðŸ“º</span>WATCH FULL<br>PLAYLIST âž”`;
                carousel.appendChild(moreCard);

                window.isPlaylistLoaded = true;
                document.getElementById('status').innerText = "BROADCAST CLEAR";
                window.checkAndStart(); 
            } catch (e) {
                document.getElementById("status").innerText = "SIGNAL INTERFERENCE (OFFLINE)";
            }
        }

        buildTuner();
        loadPlaylist(window.currentChannelId);

        // Safety check for slow API loading
        let checkCount = 0;
        const safetyCheck = setInterval(() => {
            checkCount++;
            if (window.YT && window.YT.loaded) { 
                window.checkAndStart(); 
                clearInterval(safetyCheck); 
            }
            if (checkCount > 20) clearInterval(safetyCheck);
        }, 500);
    </script>
</body>
</html>
